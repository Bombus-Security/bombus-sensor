<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    <Product Id="*" Name="Honeybee Hive Agent" Language="1033" Version="0.0.1.0" Manufacturer="Honeybee Hive" UpgradeCode="abdac55e-0c65-4e1e-bb1b-85ef9ce77925">
      <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
      <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
      <MediaTemplate EmbedCab="yes" />
      <Feature Id="ProductFeature" Title="Installer" Level="1">
        <ComponentGroupRef Id="ProductComponents" />
      </Feature>
      <UI>
        <ProgressText Action="InstallLXSS">Installing Windows Subsystem for Linux</ProgressText>
      </UI>

      <!-- ***************** -->
      <!--   PACKAGE INFO    -->
      <!-- ***************** -->
      
      <Icon Id="honeybeeIcon" SourceFile="..\..\..\honeybee.ico" />
      <Property Id="ARPPRODUCTICON" Value="honeybeeIcon" />

      <Property Id="ARPURLINFOABOUT" Value="https://hnyb.app" />
      <Property Id="ARPHELPLINK" Value="https://hnyb.app" />
      <Property Id="ALLUSERS" Value="1" />

      <!-- ***************** -->
      <!-- DIRECTORY LAYOUT  -->
      <!-- ***************** -->
      
      <Directory Id="TARGETDIR" Name="SourceDir">
        <Directory Id="ProgramFilesFolder">
          <Directory Id="INSTALLFOLDER" Name="Honeybee">
            <Directory Id="SERVICEFOLDER" Name="service">
            </Directory>
          </Directory>
        </Directory>
      </Directory>

      <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
        <!-- TODO: Remove the comments around this Component element and the ComponentRef below in order to add resources to this installer. -->
        <!-- <Component Id="ProductComponent"> -->
        <!-- TODO: Insert files, registry keys, and other resources here. -->
        <!-- </Component> -->
        <Component Id="cmpAddUser" Guid="*" KeyPath="yes">
          <util:User Id="HoneybeeServiceUser" Name="honeybee" LogonAsService="yes" UpdateIfExists="yes" />
        </Component>
        <Component Id="HoneybeeService" Guid="*">
          <ServiceInstall Name="Honeybee Service" Type="ownProcess" Start="auto" ErrorControl="" />
        </Component>

      </ComponentGroup>
      
      <!-- ***************** -->
      <!-- LAUNCH CONDITIONS -->
      <!-- ***************** -->

      <!-- Check Windows version-->
      <Condition Message= "OS must be Windows 10.">
        <![CDATA[Installed OR VersionNT >= 1000]]>
      </Condition>
      
      <!-- ***************** -->
      <!--   DEPEND CHECKS   -->
      <!-- ***************** -->
      
      <!-- Check is Linux Subsystem installed -->
      <Property Id="LXSSINSTALLED">
        <RegistrySearch Id="KernelVersion" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Lxss" Type="raw" Name="CurrentBuild" />
      </Property>
      
      <!-- Check if Docker Desktop installed -->
      <Property Id="DOCKERINSTALLED">
        <RegistrySearch Id="KernelVersion" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Lxss" Type="raw" Name="CurrentBuild" />
      </Property>

      <!-- ***************** -->
      <!--  CUSTOM ACTIONS   -->
      <!-- ***************** -->
      
      <!-- Custom action to install feature -->
      <!-- The first action sets the path to dism and the second action calls it-->
      <CustomAction Id="InstallLXSS_Set" Property="InstallLXSS" Value="&quot;[System64Folder]dism.exe&quot; /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all" Execute="immediate" />
      <CustomAction Id="InstallLXSS" BinaryKey="WixCA" DllEntry="CAQuietExec64" Execute="deferred" Return="check" />
      
      <Binary Id="dockerInstallEXE" SourceFile="..\..\..\docker-desktop.exe" />
      <CustomAction Id="dockerInstallEXE_CA" BinaryKey="dockerInstallEXE" Impersonate="no" Execute="deferred" ExeCommand="" Return="check" />
      
      <!-- Call the custom action -->
      <InstallExecuteSequence>
        <Custom Action="InstallLXSS_Set" After="CostFinalize" />
        <Custom Action="InstallLXSS" After="InstallInitialize">NOT REMOVE AND NOT LXSSINSTALLED</Custom>
        <Custom Action="dockerInstallEXE_CA" After="InstallLXSS">NOT REMOVE AND NOT DOCKERINSTALLED</Custom>
      </InstallExecuteSequence>
    </Product>
</Wix>